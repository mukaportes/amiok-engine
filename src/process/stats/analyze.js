const { getAnalysisFile } = require('../../modules/doctor');
const { mergeItemToResults, getStatsTemplate, formatAverageResults } = require('../../modules/stats');
const PROCESS_ENUM = require('../../enums/process');

const validate = (context) => {
  if (!context[PROCESS_ENUM.INFO_API_PID]) throw new Error('Missing INFO_API_PID context data');
  if (!context[PROCESS_ENUM.INFO_API_PID].apiPid) throw new Error('Missing API PID');
  if (!context[PROCESS_ENUM.SCRIPT_EXECUTE]) throw new Error('Missing SCRIPT_EXECUTE context data');
  if (!context[PROCESS_ENUM.STORAGE_PREPARE]) throw new Error('Missing STORAGE_PREPARE context data');
  if (!context[PROCESS_ENUM.STORAGE_PREPARE].storage) throw new Error('Missing STORAGE_PREPARE storage module');
  if (!context[PROCESS_ENUM.STORAGE_PREPARE].storage.storeReportFile) throw new Error('Missing STORAGE_PREPARE storage module storeReportFile()');
  if (!context[PROCESS_ENUM.TEST_SETUP]) throw new Error('Missing TEST_SETUP context data');
  if (!context[PROCESS_ENUM.TEST_SETUP].test) throw new Error('Missing TEST_SETUP test');
};

/**
 * 
 * @param {Params} _ 
 * @param {Context} context 
 * @returns {StatsAnalyzeContext}
 */
module.exports = async (_, context = {}) => {
  console.info(`Executing process ${PROCESS_ENUM.STATS_ANALYZE}`);

  try {
    validate(context);

    const { apiPid } = context[PROCESS_ENUM.INFO_API_PID];
    const { startTime, endTime } = context[PROCESS_ENUM.SCRIPT_EXECUTE];

    const results = await getAnalysisFile(apiPid);

    if (!results) throw new Error('Invalid analysis file generated by Clinic Doctor.');

    const parsedResults = JSON.parse(results);

    const {
      storage: { storeReportFile },
    } = context[PROCESS_ENUM.STORAGE_PREPARE];
    storeReportFile(context[PROCESS_ENUM.TEST_SETUP].test.id, parsedResults);

    const groupedResults = parsedResults.reduce(
      (acc, item) => {
        let accProp = 'end';

        if (item.timestamp <= startTime) {
          accProp = 'start';
        } else if (item.timestamp <= endTime) {
          accProp = 'tests';
        }

        acc[accProp] = mergeItemToResults(acc[accProp], item);

        return acc;
      },
      {
        start: getStatsTemplate(),
        tests: getStatsTemplate(),
        end: getStatsTemplate(),
      }
    );

    const formattedResults = Object.keys(groupedResults).map((key) =>
      formatAverageResults(groupedResults[key], key)
    );

    return { key: PROCESS_ENUM.STATS_ANALYZE, results: formattedResults };
  } catch (error) {
    console.error(`Error executing ${PROCESS_ENUM.STATS_ANALYZE} process`, error);

    throw error;
  }
};
